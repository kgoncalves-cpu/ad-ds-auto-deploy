
<code>
#Requires -RunAsAdministrator
<#
.SYNOPSIS
    Script de deployment de Active Directory Domain Controller
.DESCRIPTION
    Implementação modular e configurável de Domain Controller.
    
.PARAMETER ConfigFile
    Caminho para o arquivo de configuração (padrão: Config/Default.psd1)
    
.PARAMETER Mode
    Modo de execução: Interactive ou Automated
    
.EXAMPLE
    .\Deploy.ps1 -ConfigFile .\Config\Production.psd1 -Mode Interactive
    
.NOTES
    Autor: BRMC IT Team
    Versão: 2.0
    Requer: Windows Server 2022
#>

param(
    [string]$ConfigFile = "$PSScriptRoot\Config\Default.psd1",
    [string]$Mode = "Interactive"
)

# =====================================================
# INICIALIZAÇÃO
# =====================================================

$ErrorActionPreference = "Stop"
$ProgressPreference = "SilentlyContinue"

Write-Host "╔════════════════════════════════════════════════════════════╗" -ForegroundColor Cyan
Write-Host "║  DEPLOYMENT DE ACTIVE DIRECTORY - VERSÃO 2.0 MODULAR       ║" -ForegroundColor Cyan
Write-Host "║  Modo: $Mode                                               ║" -ForegroundColor Cyan
Write-Host "╚════════════════════════════════════════════════════════════╝" -ForegroundColor Cyan

# =====================================================
# CARREGAR FUNÇÕES (DOTTED SOURCING)
# =====================================================

Write-Host "`nCarregando funções..." -ForegroundColor Yellow

try {
    . "$PSScriptRoot\Functions\Logging.ps1" -ErrorAction Stop
    Write-Host "Logging.ps1 carregado" -ForegroundColor Green
} catch {
    Write-Host "Erro ao carregar Logging.ps1: $_" -ForegroundColor Red
    exit 1
}

try {
    . "$PSScriptRoot\Functions\Validation.ps1" -ErrorAction Stop
    Write-Host "Validation.ps1 carregado" -ForegroundColor Green
} catch {
    Write-Host "Erro ao carregar Validation.ps1: $_" -ForegroundColor Red
    exit 1
}

try {
    . "$PSScriptRoot\Functions\Utilities.ps1" -ErrorAction Stop
    Write-Host "Utilities.ps1 carregado" -ForegroundColor Green
} catch {
    Write-Host "Aviso: Utilities.ps1 não encontrado (não crítico)" -ForegroundColor Yellow
}

# =====================================================
# CRIAR LOGGER
# =====================================================

$logPath = "$PSScriptRoot\Logs\ADDeployment_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

try {
    $logger = [ADLogger]::new($logPath, $true, $true)
    $logger.Info("═══════════════════════════════════════════════════════════")
    $logger.Info("DEPLOYMENT DE ACTIVE DIRECTORY - VERSÃO 2.0 MODULAR")
    $logger.Info("Modo: $Mode")
    $logger.Info("═══════════════════════════════════════════════════════════")
    Write-Host "Logger inicializado" -ForegroundColor Green
} catch {
    Write-Host "Erro ao criar logger: $_" -ForegroundColor Red
    exit 1
}

# =====================================================
# CARREGAR CONFIGURAÇÃO
# =====================================================

Write-Host "`nCarregando configuração..." -ForegroundColor Yellow

try {
    if (-not (Test-Path $ConfigFile)) {
        throw "Arquivo de configuração não encontrado: $ConfigFile"
    }
    
    $config = Import-PowerShellDataFile -Path $ConfigFile
    $logger.Success("Configuração carregada: $ConfigFile")
    Write-Host "Configuração carregada com sucesso" -ForegroundColor Green
} catch {
    $logger.Error("Erro ao carregar configuração: $_")
    Write-Host "Erro: $_" -ForegroundColor Red
    exit 1
}

# =====================================================
# EXIBIR CONFIGURAÇÃO
# =====================================================

Write-Host "`nConfigração Carregada:" -ForegroundColor Yellow
Write-Host "Domínio: $($config.Domain.Name)" -ForegroundColor Gray
Write-Host "NetBIOS: $($config.Domain.NetBIOS)" -ForegroundColor Gray
Write-Host "Servidor: $($config.Server.Name)" -ForegroundColor Gray
Write-Host "IP: $($config.Network.ServerIP)" -ForegroundColor Gray
Write-Host "DHCP: $(if($config.Services.InstallDHCP){'Sim'}else{'Não'})" -ForegroundColor Gray

# =====================================================
# VALIDAÇÕES
# =====================================================

Write-Host "`nValidando configuração..." -ForegroundColor Yellow

try {
    # Validar domínio
    if (-not [ADValidator]::ValidateDomainName($config.Domain.Name)) {
        throw "Nome de domínio inválido: $($config.Domain.Name)"
    }
    $logger.Success("Domínio validado")
    Write-Host "Domínio válido" -ForegroundColor Green
    
    # Validar IP do servidor
    if (-not [ADValidator]::ValidateIPAddress($config.Network.ServerIP)) {
        throw "IP do servidor inválido: $($config.Network.ServerIP)"
    }
    $logger.Success("IP do servidor validado")
    Write-Host "IP válido" -ForegroundColor Green
    
    # Validar segmentos de rede
    foreach ($segment in $config.Network.Segments) {
        if (-not [ADValidator]::ValidateIPAddress($segment.Network)) {
            throw "IP de rede inválido: $($segment.Network)"
        }
        if (-not [ADValidator]::ValidateIPAddress($segment.Gateway)) {
            throw "Gateway inválido: $($segment.Gateway)"
        }
    }
    $logger.Success("Segmentos de rede validados")
    Write-Host "Rede válida" -ForegroundColor Green
    
    # ================================================
    # VALIDAÇÃO CRÍTICA: ServerIP no Segmento
    # ================================================
    
    Write-Host "`nValidando se ServerIP está no segmento de rede..." -ForegroundColor Yellow
    
    $segmentValidated = $false
    foreach ($segment in $config.Network.Segments) {
        $isInSegment = [ADValidator]::ValidateIPInSegment(
            $config.Network.ServerIP,
            $segment.Network,
            $segment.CIDR
        )
        
        if ($isInSegment) {
            $logger.Success("ServerIP $($config.Network.ServerIP) está no segmento $($segment.Network)/$($segment.CIDR)")
            Write-Host "ServerIP está no segmento" -ForegroundColor Green
            $segmentValidated = $true
            break
        }
    }
    
    if (-not $segmentValidated) {
        # Obter informações sobre o segmento para mensagem de erro
        $segment = $config.Network.Segments[0]
        $segmentInfo = [ADValidator]::GetSegmentInfo($segment.Network, $segment.CIDR)
        
        $errorMsg = @"
ServerIP está FORA do segmento de rede configurado!

Segmento configurado:
  - Rede: $($segment.Network)/$($segment.CIDR)
  - Máscara: $($segment.Mask)
  - Range válido: $($segmentInfo.FirstIP) - $($segmentInfo.LastIP)
  - Total de hosts: $($segmentInfo.TotalHosts)

IP do servidor:
  - $($config.Network.ServerIP) (INVÁLIDO - fora do range)

SOLUÇÃO:
  1. Altere o ServerIP para um valor dentro do range: $($segmentInfo.FirstIP) - $($segmentInfo.LastIP)
  2. OU altere o CIDR do segmento para incluir o ServerIP

Arquivo de configuração: $ConfigFile
"@
        
        $logger.Error($errorMsg)
        Write-Host "`nErro Crítico:" -ForegroundColor Red
        Write-Host $errorMsg -ForegroundColor Yellow
        exit 1
    }
    
} catch {
    $logger.Error("Erro na validação: $_")
    Write-Host "Erro: $_" -ForegroundColor Red
    exit 1
}

# =====================================================
# CONFIRMAÇÃO
# =====================================================

Write-Host ("`n" + ("=" * 64)) -ForegroundColor Cyan
$response = Read-Host "Deseja continuar com a implementação? (S/N)"

if ($response -ne 'S' -and $response -ne 's') {
    $logger.Warning("Implementação cancelada pelo usuário")
    Write-Host "`nOperação cancelada" -ForegroundColor Yellow
    exit 0
}

# =====================================================
# PRÓXIMAS FASES (TODO)
# =====================================================

$logger.Info("═══════════════════════════════════════════════════════════")
$logger.Info("Implementação iniciada")
$logger.Info("═══════════════════════════════════════════════════════════")

Write-Host "`nScript finalizado com sucesso" -ForegroundColor Green
Write-Host "Logs salvo em: $logPath" -ForegroundColor Gray

Read-Host "`nPressione ENTER para continuar"

</code>